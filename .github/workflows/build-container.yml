name: Build RouterOS Container Image

on:
  push:
    branches:
      - master # 确保分支名正确 (master 或 main)
  workflow_dispatch:

jobs:
  build-and-export:
    runs-on: ubuntu-latest
    
    steps:
      - name: 1. 检出代码 (Checkout repository)
        # 注意原项目工作流使用了 submodules: 'recursive'，我们在这里添加
        uses: actions/checkout@v4
        with:
          submodules: 'recursive' # <-- 关键：确保拉取所有依赖的子模块

      - name: 2. 构建 Docker 镜像 (Build Docker Image for x86/64)
        run: |
          docker build \
            --platform=linux/amd64 \
            -t msd-lite-custom:latest \
            .

      - name: 3. 导出镜像为 Tar 文件 (Export Image to .tar)
        run: docker save msd-lite-custom:latest -o msd-lite-custom.tar
        
      - name: 4. 上传 .tar 文件作为 Artifact (Upload Artifact)
        uses: actions/upload-artifact@v4
        with:
          name: routeros-msd-lite-x86_64
          path: msd-lite-custom.tar
          retention-days: 7
